<html>
<meta charset="utf-8">
<head><title></title></head>
<link rel="stylesheet" href="lib/bootstrap/bootstrap.css">
<script src="lib/jquery.1.7.0.min.js"></script>
<link rel="stylesheet" href="lib/jquery-ui/ui/themes/base/jquery.ui.all.css">
<link rel="stylesheet" href="css/board.css">
<body>

<div class="topbar" data-dropdown="dropdown">
  <div class="topbar-inner">
    <div class="container-fluid">
      <a class="brand" target="_blank" href="https://github.com/brendanheywood/ghello">Ghello</a>
      <ul class="nav">
        <li class="active"><a href="#" target="_blank" id="repo"></a></li>
        <li class=""><a href="#" target="_blank" id="issues">Open issues in Github â†’</a></li>
      </ul>
      <ul class="nav secondary-nav">
        <li><a href="#" class="">+ Add a stack</a>
        <li><a href="#" id="settings">Options</a></li>
<!--
        <li class="dropdown"><a href="#" class="dropdown-toggle">Settings</a>
          <ul class="dropdown-menu">
            <li><a href="#" id="settings">Options</a></li>
          </ul>
        </li>
-->
      </ul>
<!--
      <p class="pull-right">Logged in as <a id="loggedin" href="#">username</a></p>
-->
    </div>
  </div>
</div>

<div id="loading">
<div class="alert-message warning">
        <p><strong>Loading...</strong></p>
      </div>

</div>


<div class="stacks">

</div>





<script src="lib/jquery-ui/ui/jquery.ui.core.js"></script>
<script src="lib/jquery-ui/ui/jquery.ui.widget.js"></script>
<script src="lib/jquery-ui/ui/jquery.ui.mouse.js"></script>
<script src="lib/jquery-ui/ui/jquery.ui.draggable.js"></script>
<script src="lib/jquery-ui/ui/jquery.ui.sortable.js"></script>
<script src="lib/bootstrap/bootstrap-dropdown.js"></script>
<script type="text/javascript">

(function($) {
    $.QueryString = (function(a) {
        if (a == "") return {};
        var b = {};
        for (var i = 0; i < a.length; ++i)
        {
            var p=a[i].split('=');
            if (p.length != 2) continue;
            b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
        }
        return b;
    })(window.location.search.substr(1).split('&'))
})(jQuery);


var user = $.QueryString['user'];
var repo = $.QueryString['repo'];

$('title').html(repo+ ' by '+ user);
$('#repo').html(user+'/'+repo).attr('href', 'https://github.com/'+user+'/'+repo);
$('#issues').attr('href', 'https://github.com/'+user+'/'+repo+'/issues');
$('#settings').click(function(){
	chrome.tabs.create({url: "options.html"});
});

var issues;
var labels;
var labels2index = {};


function drawStacks(){
	// for each label, make a stack if it starts with 'S\d+\s'
	// also make a stack for no labels and closed

	$('#loading').fadeOut('slow');

	var stacks = [];

	// Add the first backlog stack
	stacks.push({
		name: 'Backlog',
		color: 'eeeeee'
	});
	labels = labels.sort(function(a,b){
		return a.name < b.name ? -1 : (a.name > b.name ? 1 : 0);
	});
	var labelIndex = 0;
	$.each(labels, function(index, value){
		var label = labels[index];
		var matches = label.name.match(/S\d+\s(.*)/);
		if (!matches){
			return;
		}
		labels2index[label.name] = ++labelIndex;
		stacks.push({
			name: matches[1],
			color: label.color
		});
	});

	// Add the last closed stack
	stacks.push({
		name: 'Closed',
		color: '888888'
	});
	var c;
	$.each(stacks, function(index, val){
		var stack = stacks[index];
		$('.stacks').append("<div class='stack' style='background-color: #"+stack.color+"' id='stack"+index+"'><h2>"+stack.name+"</h2><ul class='cards'></ul><a class='addcard'>Add issue</a></div>");
	});

}

function drawCards(){
}


var labelsPromise = $.ajax({
	url: 'https://api.github.com/repos/'+user+'/'+repo+'/labels',
	success: function(data){
		labels = data;
		drawStacks();
	},
	error: function(){
		alert('Error loading labels');
	}
});
var issuePromise = $.ajax({
	url: 'https://api.github.com/repos/'+user+'/'+repo+'/issues?',
	success: function(data){
		issues = data;
	},
	error: function(){
		alert('Error loading issues');
	}
});


/*
 * given an issue find out which stack it should be in
 */
function getStack(issue){
	var stack = 0; // default to backlog

	// if issues is closed then it is always last stack

	// run through labels, first match exit
	$.each(issue.labels, function(i,v){
		if (labels2index[v.name]){
			stack = labels2index[v.name];
		}
	});

	return stack;	
}


/*
 * When both the labels and the issues are loaded then render the issues
 */
$.when(labelsPromise, issuePromise).then(function(){
	
	$.each(issues, function(index, val){

		var issue = issues[index];

		// what stack is it?
		var stack = getStack(issue);

		// draw an issue
		var html = "<li><span class='num'>#"+issue.number+"</span> <span class='title'>"+issue.title+"</span>";
		var tags = [];
		if (issue.labels){
			$.each(issue.labels, function(i, v){
				var matches = v.name.match(/S\d+\s(.*)/);
				if (!matches){
					tags.push(v);
				}
			});
		}
		if (tags.length != 0){
			html += "<ul class='labels'>";
			$.each(tags, function(i, v){
				html += "<li style='border-color: #"+v.color+"'>"+v.name+"</li>";
			});
			html += "</ul>";
		}
		if (issue.assignee){
			html += "<a href='#' class='avatar'><img width=24 height=24 src='"+issue.assignee.avatar_url+"'></a>";
		}

		html += "</li>";
		var li = $(html);
		$('#stack'+stack+' > ul').append(li);


	});


	$(".stacks").sortable({
	});
	$(".cards").sortable({
		connectWith: '.cards'
	});
});

</script>
</body>
</html>
